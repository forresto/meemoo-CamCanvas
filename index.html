<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  
  <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script src="http://meemoo.org/meemoo/meemoo.js"></script>
  
<title>Camcanvas - Webcam to Canvas JavaScript API</title>

</head>

<body onload="pageLoad();">

  <button onclick="captureToCanvas()">Capture to Canvas</button>

  <div id="webcam">
    <div id="embedflash">
      This module uses a flash webcam to get an image to the canvas.
    </div>
  </div>

  <div>
    <canvas style="border:1px solid #AAA" id="canvas" width="320" height="240"></canvas>
  </div>

  <script type="text/javascript">
   
    var gCtx = null;
    var gCanvas = null;

    var imageData = null;
    var ii=0;
    var jj=0;
    var c=0;

    var w;
    var h;

    function pageLoad() { 
     init(320,240);
    }

    function init(ww, hh) {
      w = ww;
      h = hh;
      initFlash();
      initCanvas();
    }
     
    function initFlash () {
      var flashvars = {};
      var params = {
        "quality": "high",
        "allowScriptAccess": "always",
        // "scale": "noscale"
      };
      var attributes = {
        "mayscript": "true"
      };
      
      swfobject.embedSWF("camcanvas.swf", "embedflash", w, h, "9.0.0", null, flashvars, params, attributes, function(e){
        if (e.success) {
          setTimeout ( function () {
            var flash = document.getElementById("embedflash");
            flash.ccInit(null,w,h);
          }, 1000 );
        }
      });
      
    }
     
    function initCanvas() {
      gCanvas = document.getElementById("canvas");
      gCanvas.style.width = w + "px";
      gCanvas.style.height = h + "px";
      gCanvas.width = w;
      gCanvas.height = h;
      gCtx = gCanvas.getContext("2d");
      gCtx.clearRect(0, 0, w, h);
      imageData = gCtx.getImageData( 0, 0, w, h );
    }

    function passLine(stringPixels) { 
      //a = (intVal >> 24) & 0xff;

      var coll = stringPixels.split("-");
      
      console.log(coll.length);

      for (var i=0; i<w; i++) { 
        var intVal = parseInt(coll[i]);
        r = (intVal >> 16) & 0xff;
        g = (intVal >> 8) & 0xff;
        b = (intVal ) & 0xff;
        imageData.data[c+0] = r;
        imageData.data[c+1] = g;
        imageData.data[c+2] = b;
        imageData.data[c+3] = 256;
        c+=4;
      } 

      if ( c >= w*h*4 ) { 
        c=0;
        gCtx.putImageData(imageData, 0,0);
      } 
    } 

    function captureToCanvas() {
      var flash = document.getElementById("embedflash");
      flash.ccCapture();
      Meemoo.send("image", imageData);
    }
    
    
    //
    // Meemoo stuff
    //
    
    Meemoo.setInfo({
      title: "cam",
      author: "taboca + Forrest Oliphant",
      description: "flash webcam image to canvas"
    }).addInputs({
      capture: {
        action: captureToCanvas,
        port: true,
        type: "bang"
      }
    }).addOutputs({
      image: { 
        port: true,
        type: "image"
      }
    });
    
  </script>


</body>
</html>
